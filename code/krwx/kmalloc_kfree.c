#include <stdio.h>
#include "../../kernel/KRWX/client/lib/krwx.h"

/* 
* For the expected results it is necessary to have FREELIST_[RANDOM|HARDENED] disabled
*/

int main(){
  #define CHUNK_SZ 64
  // Fill partial slabs
  for(int i = 0; i < 1000; i++)
    kmalloc(CHUNK_SZ, GFP_KERNEL);

  // Allocate chunks
  void* chunk_A = kmalloc(CHUNK_SZ, GFP_KERNEL);
  void* chunk_B = kmalloc(CHUNK_SZ, GFP_KERNEL);
  void* chunk_C = kmalloc(CHUNK_SZ, GFP_KERNEL);

  // Fill chunks with arbitrary data
  int off = 0;
  while( off < CHUNK_SZ){
    kwrite64(chunk_A + off, 0x4141414141414141);
    off += 8;
  }
  off = 0;
  while( off < CHUNK_SZ){
    kwrite64(chunk_B + off, 0x4242424242424242);
    off += 8;
  }
  off = 0;
  while( off < CHUNK_SZ){
    kwrite64(chunk_C + off, 0x4343434343434343);
    off += 8;
  }

  // Reading memory, freeing and re-reading memory again
  printf("[*] Reading memory ..\n");
  read_memory(chunk_A, CHUNK_SZ * 3);
  kfree(chunk_B);
  printf("[*] Freeing chunk_B and re-reading memory\n");
  read_memory(chunk_A, CHUNK_SZ * 3);

  printf("chunk_A: %p\n", chunk_A);
  printf("chunk_B: %p\n", chunk_B);
  printf("chunk_C: %p\n", chunk_C);
  printf("chunk_C - chunk_B = %d\n", (chunk_C - chunk_B) );
  printf("chunk_B - chunk_A = %d\n", (chunk_B - chunk_A) );
}
