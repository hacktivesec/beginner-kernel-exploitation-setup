#!/bin/sh
# Compiles and move the compiled executable in rootfs

if [ -z "$2" ]
  then
    echo "Usage: $0 <source-code.c> <image-chroot>"
    echo "        Example:"
    echo "           $0 ./code/hello_world.c ./image/chroot/"
    echo "           CC=clang $0 ./code/hello_world.c ./image/chroot/"
    exit
fi
set -ex

# CC= ./ to override
CC_DEFAULT=$(which cc)
: "${CC:=$CC_DEFAULT}"
IMAGE_CHROOT=$2

# Clean previous compilations
sudo find $IMAGE_CHROOT/root/ -type f -exec rm {} +



exec_name=$(echo $1 | sed "s/\.c//g")
$CC -static $1 -o $exec_name
sudo cp $exec_name $IMAGE_CHROOT/root/

sudo bash -c "cat << EOF > $IMAGE_CHROOT/root/run
if [ ! -f .setup ]; then
  adduser --disabled-password --gecos '' user
  cp * /home/user/
  touch /home/user/.setup
  chown -R user: /home/user/*
  dmesg -n 1
  # Install KRWX and make it 777
  lsmod | grep krwx >/dev/null || insmod /krwx.ko
  chmod 777 /dev/krwx
  touch .setup
fi
# Execute compiled binary
./$(basename $exec_name)

EOF"

sudo chmod +x $IMAGE_CHROOT/root/run


