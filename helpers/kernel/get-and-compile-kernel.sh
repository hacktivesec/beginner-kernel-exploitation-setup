#!/bin/bash

if [ -z "$1" ]
  then
    echo "Usage: $0 {kernel-version} {work-folder} <kernel-CONFIG-file>"
    echo "        Example:"
    echo "           $0 6.4"
    echo "           $0 6.4 /tmp/work-folder"
    echo "           $0 6.4 /tmp/work-folder kernel-configs/extra-debug.config"
    echo "           CC=clang $0 6.4 /tmp/work-folder"
    echo "           ARCH=x86_64 CROSS_COMPILE=x86_64-linux-gnu- $0 6.4 /tmp/work-folder"
    exit
fi

set -ex

START_FOLDER=$(pwd)
# workdir
if [ -n "$2" ]
  then
    cd $2
fi

# Terminate in any command fail
echo "[*] Working in folder $(pwd)"
KERNEL_VERSION=$1
EXTRA_CONFIG_FILE=$3
TAR_FILENAME=linux-$KERNEL_VERSION.tar.xz
KERNEL_FOLDER=linux-$KERNEL_VERSION/

CC_DEFAULT=$(which cc)
: "${CC:=$CC_DEFAULT}"

# CROSS_COMPILE & ARCH can be used as env variables for cross compilation
# doing it before to don't waste time later and restart
if [ -z ${CROSS_COMPILE+x} ]; 
  then 
    echo "[*] ;)";
  else 
    # check also if arch is set
    if [ -z ${ARCH+x} ]; then echo "missing arch !"; exit; fi
    echo "[*] cross compiling from $(arch) to $ARCH"
fi

# getting the kernel
wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-$KERNEL_VERSION.tar.xz
tar -xvf $TAR_FILENAME
cd $KERNEL_FOLDER

# already done from calling script
# sudo apt-get install build-essential libncurses-dev bison flex libssl-dev libelf-dev flex bison

echo "[*] Configuring kernel options .."

if [ -z ${cross_compile+x} ]; 
  then 
    # Normal compilation (no cross)
    make CC=$CC defconfig
    make CC=$CC kvm_guest.config

    # custom config
    if [ -n "$3" ]
      then
        # Add specified extra configs
        cat $EXTRA_CONFIG_FILE >> .config
    fi

    make CC=$CC olddefconfig
    time make CC=$CC -j $(nproc)

  else 
    # Cross compilation
    make ARCH=$ARCH CROSS_COMPILE=$CROSS_COMPILE defconfig
    make ARCH=$ARCH CROSS_COMPILE=$CROSS_COMPILE kvm_guest.config

    # custom config
    if [ -n "$3" ]
      then
        # Add specified extra configs
        cat $EXTRA_CONFIG_FILE >> .config
    fi

    make ARCH=$ARCH CROSS_COMPILE=$CROSS_COMPILE olddefconfig
    time make ARCH=$ARCH CROSS_COMPILE=$CROSS_COMPILE -j $(nproc)

fi

echo "[+] Everything done @_@"
