if [ -z "$3" ]
  then
    echo "A work folder must be specified!"
    echo "Usage: $0 <kernel-folder> <work-folder> <image-chroot>"
    echo "        Example:"
    echo "           $0 ./kernel/linux-6.1/ ./kernel/ ./image/chroot/"
    exit
fi
set -ex 

cd $2

if [ ! -d ./KRWX ]; then
  # already cloned
  git clone https://github.com/hacktivesec/KRWX
fi

cd KRWX/LKM/
# compile kernel module
make -C $1 M=$(pwd) modules

# copy it into the image folder
sudo cp krwx.ko $3/
