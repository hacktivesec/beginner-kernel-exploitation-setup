#!/bin/bash
set -ex

MOUNT_PATH=/mnt/kernel-mnt-image/
KERNEL_VERSION=6.4
KERNEL_PARENT_FOLDER=$PWD/kernel/
KERNEL_FOLDER=$PWD/kernel/linux-$KERNEL_VERSION
KERNEL_IMAGE=$KERNEL_FOLDER/arch/x86_64/boot/bzImage
KERNEL_EXTRA_CONFIGS=$PWD/kernel/kernel-configs/extra-debug.config
IMAGE_FOLDER=$PWD/image/
IMAGE_FOLDER_CHROOT=$IMAGE_FOLDER/chroot/
IMAGE=$IMAGE_FOLDER/bullseye.img
# apt dependencies
sudo apt update
sudo apt install -y debootstrap qemu-system build-essential libncurses-dev bison flex libssl-dev libelf-dev bc git make


# setup
sudo mkdir -p $MOUNT_PATH

# compile kernel
helpers/kernel/get-and-compile-kernel.sh $KERNEL_VERSION $KERNEL_PARENT_FOLDER $KERNEL_EXTRA_CONFIGS
# get debian image from syzkaller repo
helpers/image/get-syzkaller-image.sh $IMAGE_FOLDER
# get and compile KRWX
helpers/kernel/get-and-compile-KRWX.sh $KERNEL_FOLDER $KERNEL_PARENT_FOLDER $IMAGE_FOLDER_CHROOT

# Configure main script ./start.sh
ESC_MOUNT_PATH=$(echo "$MOUNT_PATH" | sed 's/[\/&]/\\&/g')
ESC_KERNEL_IMAGE=$(echo "$KERNEL_IMAGE" | sed 's/[\/&]/\\&/g')
ESC_IMAGE_FOLDER=$(echo "$IMAGE_FOLDER" | sed 's/[\/&]/\\&/g')
sed -e "s/TODO_MOUNT_PATH/$ESC_MOUNT_PATH/g" -e "s/TODO_KERNEL/$ESC_KERNEL_IMAGE/g" -e "s/TODO_IMAGE_FOLDER/$ESC_IMAGE_FOLDER/g" helpers/userland/start.sh > start.sh
chmod +x start.sh

echo "[+] Setup completed. Execute \`./start.sh ./code/hello_world.c\` and then \`/.run\` inside the qemu machine for a first quick test!"
